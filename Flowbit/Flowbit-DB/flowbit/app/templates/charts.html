{% extends "base.html" %}

{% block head %}
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
{% endblock %}

{% block script %}
<script type="text/javascript">
	// Load the Visualization API and the piechart package.
	google.load('visualization', '1.0', {'packages':['corechart']});

	// Set a callback to run when the Google Visualization API is loaded.
	google.setOnLoadCallback(initializeChart);

	/*---Start Chart---*/
	var seriesData = null;
	var seriesDataClone = null;
	var chart = null;
	var lastTime = null; //last time of data picked up
	var stream = 0; //default 0
	
	var database_host = "{{ host }}";
	var system_name = "{{ system }}";
	
	var interval = 5000;
	var intervalHandle = null;

	var options = {
					width: 430,
					height: 300,
					title: 'Flow Rate (L/min)' // Default stream 0
				};
	
	function initializeChart(system, timeSpan){
		if(typeof(timeSpan) == 'undefined') timeSpan = 5;
		
		var currentTime = Math.round((new Date()).getTime()/1000);
		//find better way to get last X minutes and to update xaxis ticker
		var sinceTime = currentTime - (timeSpan * 60);
		//var stream = getStream();
		
		var jsonData = $.ajax({
			url: "http://" + database_host + ":8080/data/" + system
					+ "?" + "app=charts" 
					+ "&" + "stream=" + stream 
					+ "&" + "since=" + sinceTime,
			dataType:"json",
			async: false
			}).responseText;

		// Create our data table out of JSON data loaded from server.
		seriesData = new google.visualization.DataTable(jsonData);
		seriesDataClone = seriesData.clone();

		lastTime = (seriesData.getValue(seriesData.getNumberOfRows() - 1, 0)).getTime() / 1000 - (7 * 3600 - 30); //there is a +7 hrs time difference. not sure why. temporary hack

		// Instantiate and draw our chart, passing in some options.
		chart = new google.visualization.LineChart(document.getElementById('chart_div'));
		chart.draw(seriesData, options);
		
		//alert(lastTime);
		//alert(currentTime);
	}
	
	// Reaaaaaaaaaaally hacky using the pairs method to remove old data when updating charts. In short, not consistent because the JSON is very different from initializing charts. Also not as accurate as finding the exact time.
	function updateChart(system){
		//alert("ppp");
		//var currentTime = Math.round((new Date()).getTime()/1000);

		var jsonData = $.ajax({
			url: "http://" + database_host + ":8080/data/" + system
					+ "?" + "app=updatecharts" 
					+ "&" + "stream=" + stream 
					+ "&" + "since=" + lastTime,
			dataType:"json",
			async: false
			}).responseText;

		// Holder for new data
		var newData = JSON.parse(jsonData);
		//alert("jk");

		// var listIndex = seriesData.getFilteredRows([{column: 0, maxValue: new Date((2 * currentTime - lastTime) * 1000)}]);   //get indicies of time less than: how long has passed since last time update = c + (c - l)

		//alert(newData.numPairs);
		//alert(lastTime);

		// For unordered rows
		// for (var i = 0; i < listIndex.length; i++){
		// 	seriesData.removeRow(listIndex[i]);
		// }

		// Assume ordered list
		if (newData.numPairs != 0) {
			alert("L");
			seriesData = seriesDataClone;
			seriesData.removeRows(0, newData.numPairs);
			alert("PPP?");
			lastTime = (seriesData.getValue(seriesData.getNumberOfRows() - 1, 0)).getTime() / 1000 - (7 * 3600 - 30); //there is a +7 hrs time difference. not sure why. temporary hack
						
			for (var i = 0; i < newData.numPairs; i++){
				seriesData.addRow([new Date(newData.xaxis * 1000), {v: newData.yaxis}]);
			}

			seriesDataClone = seriesData.clone();

			chart.draw(seriesData, options);

			alert(lastTime);
		}
	//	alert("OALO");
	}
		
	function clearSeries()
	{
		seriesData = null; //delete object somehow
	}
	
	function changeSpan(sinceTime)
	{
		clearInterval(intervalHandle);
		clearSeries();
		
		initializeChart(system_name, sinceTime);
		//intervalHandle = setInterval(function(){ updateChart(system_name); }, interval);
	}
	
	function changeStream(newStream)
	{
		clearInterval(intervalHandle);
		clearSeries();
		
		stream = newStream;

		if (stream == 1) {
			options.title = 'Water Temperature (C)';
		} else if (stream == 0) {
			options.title = 'Flow Rate (L/min)';
		} else if (stream == 3) {
			options.title == 'Outside Temperature (C)';
		}

		initializeChart(system_name);
		//intervalHandle = setInterval(function(){ updateChart(system_name); }, interval);
	}
	
	$(function(){//ensures DOM ready
		//This is only temporary to pick up the correct stream based 
		//on what chart is being displayed. need to find a better 
		//solution.
		// function getStream()
		// {
		// 	//needs to be DOM ready
		// 	var chartName = document.getElementById("chartName").innerHTML;
			
		// 	if (chartName == "Tank Water Temperature (SI)") {
		// 		return 0
		// 	} else if (chartName == "Tank Water Temperature (US)") {
		// 		return 1;
		// 	} else if (chartName == "External Temperature (SI)") {
		// 		return 2;
		// 	} else if (chartName == "External Temperature (US)") {
		// 		return 3;
		// 	} else if (chartName == "Flow Rate (SI)") {
		// 		return 4;
		// 	}
		// } 

		initializeChart(system_name);
		//setTimeout(function(){ /*Delay*/ }, interval);
		//intervalHandle = setInterval(function(){ updateChart(system_name); }, interval);
	});
	/*---End Chart---*/
</script>
{% endblock %}

{% block header %}
	<div data-role="header" data-theme="c"> 
		<h1>{{ system }}</h1> 
	</div>
{% endblock %}

{% block body %}
	<!--Content-->
	<div data-role="content">
		<div id="chart_div"></div>
	</div>
	<div data-role="footer" data-id="stream" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#" onclick="changeSpan(1);">1 Minute</a></li>
				<li><a href="#" class="ui-btn-active" onclick="changeSpan(5);">5 Minutes</a></li>
				<li><a href="#" onclick="changeSpan(30);">30 Minutes</a></li>
				<li><a href="#" onclick="changeSpan(60);">Hour</a></li>
			</ul>
			<ul>
				<li><a href="#" class="ui-btn-active" onclick="changeStream(0);">Flow Rate</a></li>
				<li><a href="#" onclick="changeStream(1);">Water Temp</a></li>
				<li><a href="#" onclick="changeStream(3);">Outside Temp</a></li>
			</ul>
		</div>
	</div><!-- /footer -->
{% endblock %}
